name: Build and Test Java Application

on:
   push:
      branches:
         - main
   pull_request:
      branches:
         - main

jobs:
   build-and-test:
      runs-on: ubuntu-latest

      steps:
         # Step 1: Checkout code
         - name: Checkout code
           uses: actions/checkout@v4

         # Step 2: Set up JDK 17
         - name: Set up JDK 17
           uses: actions/setup-java@v4
           with:
              java-version: "17"
              distribution: "temurin"
              cache: maven

         # Step 3: Build and Test with Maven
         - name: Build with Maven
           run: mvn -B package --file pom.xml

   publish-artifact:
      needs: build-and-test
      runs-on: ubuntu-latest
      steps:
         - name: Download artifact
           uses: actions/download-artifact@v4
           with:
              name: java-app

         - name: List artifact contents
           run: ls -l java-app

         - name: Upload artifact
           uses: actions/upload-artifact@v4
           with:
              name: java-app
              path: target/*.jar

   github-publish:
      needs: publish-artifact
      runs-on: ubuntu-latest
      steps:
         - name: Checkout code
           uses: actions/checkout@v4

         - name: Set up JDK 17
           uses: actions/setup-java@v4
           with:
              java-version: "17"
              distribution: "temurin"

         - name: Configure Maven for GitHub Packages
           run: |
              echo "<settings><servers><server><id>github</id><username>${{ github.actor }}</username><password>${{ secrets.GITHUB_TOKEN }}</password></server></servers></settings>" > $HOME/.m2/settings.xml

         - name: Publish to GitHub Packages
           run: mvn deploy -DaltDeploymentRepository=github::default::https://maven.pkg.github.com/diogoguedes11/java-cicd
